#include "opencm3hal.h"
#include <libopencm3/stm32/rcc.h>
#include <libopencm3/cm3/scb.h>
#include <libopencm3/stm32/rtc.h>

#define HAL_BR_SYSTEM  0
#define HAL_BR_BOOTLOADER  1

void hal_setup_clock(void);

void hal_system_start(void)
{
 if( (hal_read_backup_register(HAL_BR_SYSTEM) & HAL_BR_BOOTLOADER) != 0)
      {
      hal_write_backup_register(HAL_BR_SYSTEM, 0);
      hal_jump_to_bootloader();
      }
}

void hal_system_init(void)
{
 hal_system_start();
 hal_setup_clock();
{% for mapper in config.mappers -%}
 {{mapper.prefix}}{{mapper.name}}s_init();
{% endfor %}
}

void hal_system_shutdown(void)
{
{% for mapper in config.mappers -%}
{% if mapper.has_shutdown -%}
 {{mapper.prefix}}{{mapper.name}}s_shutdown();
{% endif -%}
{% endfor %}
}

void hal_system_bootloader(void)
{
 hal_system_shutdown();
 vTaskDelay(500 / portTICK_PERIOD_MS);
 hal_write_backup_register(HAL_BR_SYSTEM, HAL_BR_BOOTLOADER);
 scb_reset_system();
}

void hal_setup_clock(void)
{
 {{ options.hal.clock }}
}

void hal_system_reboot(void)
{
 hal_system_shutdown();
 vTaskDelay(500 / portTICK_PERIOD_MS);
 scb_reset_system();
}

uint32_t hal_read_backup_register(uint8_t no)
{
 return RTC_BKPXR(no);
}

void hal_write_backup_register(uint8_t no, uint32_t value)
{
 pwr_disable_backup_domain_write_protect();
 RTC_BKPXR(no) = value;
}